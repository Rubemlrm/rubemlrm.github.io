I"l)<p>Ora boas tardes,</p>

<p>Depois de algum tempo sem escrever nada no blog , trago-vos um script em perl acabado de sair do forno que nos permite adicionar , remover , listar , verificar , desativar os nossos virtualhosts.</p>

<p>Para tal temos temos ao nosso dispor as seguintes opções:</p>
<ul>
  <li><strong>-add</strong> : para adicionar um virtualhost no apache , para tal basta usar a seguinte sintax:</li>
</ul>
<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nb">sudo</span> ./apache <span class="nt">-add</span> </code></pre></figure>

<ul>
  <li>ex:</li>
</ul>
<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nb">sudo</span> ./apache <span class="nt">-add</span> www.rubemlrm.com rubemlrm</code></pre></figure>

<ul>
  <li><strong>-rem</strong>: para remover um virtualhost no apache, para tal basta usar a seguinte sintax:</li>
</ul>
<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nb">sudo</span> ./apache <span class="nt">-rem</span> </code></pre></figure>

<ul>
  <li>ex:</li>
</ul>
<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nb">sudo</span> ./apache <span class="nt">-rem</span> www.rubemlrm.com</code></pre></figure>

<ul>
  <li><strong>-dis</strong> : para desativar um virtualhost no apache , para tal basta usar a seguinte syntax:</li>
</ul>
<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nb">sudo</span> ./apache <span class="nt">-dis</span> </code></pre></figure>

<p>ex:</p>
<figure class="highlight"><pre><code class="language-shell" data-lang="shell"> <span class="nb">sudo</span> ./apache <span class="nt">-dis</span> www.rubemlrm.com </code></pre></figure>

<ul>
  <li><strong>-c</strong> :Esta opção poderá receber um argumento que é o <url> para mostrar a informação do virtualhost , caso não se passe o argumento do url irá mostrar todos os .conf que estão na diretoria /etc/apache2/sites-enabled/. Para tal basta usar a seguinte sintax:</url></li>
</ul>
<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nb">sudo</span> ./apache <span class="nt">-c</span> <span class="c">#irá listar todos os .conf da directoria</span></code></pre></figure>
<p> 
ou</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nb">sudo</span> ./apache <span class="nt">-c</span> www.rubemlrm.com <span class="c">#para mostrar o conteudo do .conf deste url</span></code></pre></figure>

<ul>
  <li><strong>-h</strong> : Por fim temos esta opção para nos mostrar os comandos que temos disponíveis.</li>
</ul>
<figure class="highlight"><pre><code class="language-shell" data-lang="shell">./apache <span class="nt">-h</span></code></pre></figure>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>De seguida fica o código do script:
</code></pre></div></div>

<noscript><pre>#!/usr/bin/perl
use warnings;
use strict;
my $userhome = &quot;nome de utilizador&quot;;
######################################################
#  Script para gerir VirtualHosts no Apache          #
#                                                    #
#  Permite adicionar , remover , verificar , listar, #
#  desactivar os vhosts que temos na mossa máquina.  #
#                                                    #
#  Developed by Rubem Mota                           #
#  Twitter: @rubemlrm                                #
#  Site: rubemlrm.com                                #
######################################################


#funcoes
sub AddEntry($){
    my $info = $_[0];
    
    #valida o número de valores do array
    if($info eq &#39;2&#39;){
        die(&quot;Erro: Número de argumentos inválido\n&quot;);
    }else{
    
        my $dir = @$info[1];
        my $url = @$info[0];

        #validação do url
        if($url !~ /(\w+\.){2,}[a-z]{2,4}$/){
            print(&quot;Erro: URL inválido\n&quot;);
            exit(1);
        }

        #extrai a informação relativa ao dominio do url
        my $domain = substr($url,4);
        #verifica se a directoria existe
        if(!-d &quot;/home/rubem/public_html/$dir/&quot;){
            print &quot;erro directoria não existe\n&quot;;
            DirOp($dir,&#39;newFolder&#39;);
        }else{
            #verifica se o ficheiro existe
            if(-f &quot;/etc/apache2/sites-enabled/$url.conf&quot;){
                print &quot;Ficheiro ja existe!\n&quot;;
                exit(1);
            }
            DirOp($dir,&#39;repairDirTree&#39;);
            open(FILE, &quot;&gt;/etc/apache2/sites-enabled/$url.conf&quot;) ||die($!);
            print FILE &quot;&lt;VirtualHost *:80&gt;\n&quot;;
            print FILE &quot;\tServerAdmin webmaster\@$domain\n&quot;;
            print FILE &quot;\tServerName $url\n&quot;;
            print FILE &quot;\tServerAlias $domain\n&quot;;
            print FILE &quot;\t#Index + Directory Root\n&quot;;
            print FILE &quot;\tDirectoryIndex index.html\n&quot;;
            print FILE &quot;\tDocumentRoot /home/$userhome/public_html/$dir/htdocs/\n&quot;;
            print FILE &quot;\t#CGI Directory\n&quot;;
            print FILE &quot;\tScriptAlias /cgi-bin/ /home/$userhome/public_html/$dir/cgi-bin/\n&quot;;
            print FILE &quot;\t&lt;Location /cgi-bin&gt;\n&quot;;
            print FILE &quot;\t\toptions +ExecCGI\n&quot;;
            print FILE &quot;\t&lt;/Location&gt;\n&quot;;
            print FILE &quot;\t#LogFiles\n&quot;;
            print FILE &quot;\tErrorLog /home/$userhome/public_html/$dir/logs/error.log\n&quot;;
            print FILE &quot;\tCustomLog /home/$userhome/public_html/$dir/logs/access.log combined\n&quot;;
            print FILE &quot;&lt;/VirtualHost&gt;&quot;;
            close(FILE);
            system(&quot;/etc/init.d/apache2 restart&quot;);
            print &quot;VirtualHost $url adicionado\n&quot;;
            
        }


    }
}
sub DirOp($$){
    my $dir = $_[0];
    my $opt = $_[1];
    if($opt eq &#39;newFolder&#39;){
        print &quot;Deseja que o script crie a directoria ?(S/N)\n&quot;;
        chomp(my $choice=&lt;STDIN&gt;);
        if($choice !~ /[S|s|n|N]/){
            print &quot;opcao inválida&quot;;
        }elsif($choice eq &#39;S&#39; || $opt eq &#39;s&#39;){
            mkdir(&quot;/home/$userhome/public_html/$dir&quot;) || die &quot;$!&quot;;
            mkdir(&quot;/home/$userhome/public_html/$dir/htdocs/&quot;) || die &quot;$!&quot;;
            mkdir(&quot;/home/$userhome/public_html/$dir/cgi-bin/&quot;) || die &quot;$!&quot;;
            mkdir(&quot;/home/$userhome/public_html/$dir/logs/&quot;) || die &quot;$!&quot;;
            print &quot;Pastas criadas\n&quot;;    
        }else{
            print &quot;O programa irá encerrar\n&quot;;
            exit(1);
        }
    }elsif($opt eq &#39;repairDirTree&#39;){
        if(!-d &quot;/home/rubem/public_html/$dir/htdocs/&quot;){
            mkdir(&quot;/home/$userhome/public_html/$dir/htdocs/&quot;) || die&quot;$!&quot;;
        }elsif(!-d &quot;/home/$userhome/public_html/$dir/cgi-bin/&quot;){
            mkdir(&quot;/home/$userhome/public_html/$dir/cgi-bin/&quot;) || die &quot;$!&quot;;
        }elsif(!-d &quot;/home/$userhome/public_html/$dir/logs/&quot;){
            mkdir(&quot;/home/$userhome/public_html/$dir/logs/&quot;) || die &quot;$!&quot;;
        }else{
            print &quot;&quot;;
        }
    }
}
sub RemEntry($){
        my $url = $_[0];
        if($url !~ /(\w+\.){2,}[a-z]{2,4}$/){
            print(&quot;Erro: Parametro invalido\n&quot;);
            exit(1);
        }else{
            my $flag = `ls /etc/apache2/sites-enabled/ || grep $url.conf`;
            if(!$flag){print&quot;Ficheiro não existe\n&quot;;die(1);}else{
                unlink(&quot;/etc/apache2/sites-enabled/$url.conf&quot;);
                system(&quot;/etc/init.d/apache2 restart&quot;);
                print &quot;VirtualHost $url removido\n &quot;;
            }
        }

}
sub CheckEntry($){
    my $check = $_[0];
    if($check =~ /0/){
        my $sites = `ls /etc/apache2/sites-enabled/ || grep *.config`;
        print $sites;
    }else{
        my $siteconf = `cat /etc/apache2/sites-enabled/$check.conf`;
        print $siteconf.&quot;\n&quot;;
    
    }
}
sub DisEntry($){
    my $url = $_[0];
    if($url !~ /(\w+\.){2,}[a-z]{2,4}$/){
        print &quot;Erro: Paramentro invalido\n&quot;;
        exit(1);
    }else{
        my $flag = `ls /etc/apache2/sites-enabled/$url.conf`;
        if (!$flag){print &quot;Ficheiro não existe&quot;;}else{system(&quot;mv /etc/apache2/sites-enabled/$url.conf /etc/apache2/sites-available/$url.conf&quot;);};
        system(&quot;/etc/inid.d/apache2 restart&quot;); 
    }
}

sub Main(){
    my $opt;
    if((@ARGV == 0 || $ARGV[0] !~ /^-(ad|rem|c|h|dis)$/)){
        print &quot;Primeiro Argumento inválido\n&quot;;
    }else{
        $opt = $ARGV[0];
        shift(@ARGV);
        if($opt eq &#39;-ad&#39;){
            AddEntry(\@ARGV);
        }elsif($opt eq &#39;-rem&#39;){
            RemEntry($ARGV[0]);
        }elsif($opt eq &#39;-c&#39;){
            if(@ARGV == 1){
            CheckEntry($ARGV[0]);
            }elsif(@ARGV == 0){
            CheckEntry(0);
            }else{
                print &quot;Número de paramentros inválidos\n&quot;;
            }
        }elsif($opt eq &#39;-h&#39;){
            print &quot;:=====================================:\n&quot;;
            print &quot;:            MENU DE Ajuda            :\n&quot;;
            print &quot;: -add &lt;url&gt; &lt;directoria&gt;             :\n&quot;;
            print &quot;: ex: -add www.rubemlrm.com rubemlrm  :\n&quot;;
            print &quot;: -rem &lt;url&gt;                          :\n&quot;;
            print &quot;: ex: -rem www.rubemlrm.com           :\n&quot;;
            print &quot;: -c &lt;url&gt;                            :\n&quot;;
            print &quot;: ex: -c www.rubemlrm.com             :\n&quot;;
            print &quot;: -c (Esta opção lista todos os .conf :\n&quot;;
            print &quot;: -dis &lt;url&gt;                          :\n&quot;;
            print &quot;: ex: -dis www.rubemlrm.com           :\n&quot;;
            print &quot;:=====================================:\n&quot;;
        }else{
          DisEntry($ARGV[0]);
        }
    }
}

Main();</pre></noscript>
<script src="https://gist.github.com/rubemlrm/3387796.js"> </script>

:ET